<?php
/**
 * Обрабатывает тест, загружает вопросы из файла и вычисляет результаты.
 * 
 * Файл `data.json` используется для хранения данных о вопросах и результатах тестов.
 * После прохождения теста результаты сохраняются в этом файле.
 * 
 * Обрабатываются данные формы, подсчитываются правильные ответы и вычисляется процент правильных ответов.
 * Затем результаты записываются в файл и происходит перенаправление на страницу с результатами.
 */

$dataFile = "testData.json";

/**
 * Проверяет наличие файла с данными.
 * 
 * Если файл `data.json` отсутствует, выводится сообщение об ошибке и выполнение скрипта прекращается,
 * чтобы избежать попытки работы с несуществующими данными.
 */
if (!file_exists($dataFile)) {
    echo "Файл данных не найден.";
    exit;
}

/**
 * Загружает и декодирует данные из JSON-файла.
 * 
 * Считывает содержимое файла `data.json` и преобразует его в ассоциативный массив.
 * Если ключ "questions" отсутствует, используется пустой массив по умолчанию.
 */
$data = json_decode(file_get_contents($dataFile), true);
$questions = $data["questions"] ?? [];

/**
 * Проверяет наличие вопросов в загруженных данных.
 * 
 * Если массив вопросов пуст, выводится сообщение об ошибке и выполнение скрипта прекращается,
 * так как тест без вопросов невозможен.
 */
if (empty($questions)) {
    echo "Нет вопросов для теста.";
    exit;
}

/**
 * Обработка POST-запроса.
 * 
 * Если запрос отправлен методом POST, выполняется подсчет правильных ответов.
 */
if ($_SERVER["REQUEST_METHOD"] === "POST") {
    $username = $_POST["username"];

    /**
     * Получает ответы пользователя
     * 
     * Если ответов нет, то по умолчанию используется пустой массив.
     */
    $userAnswers = $_POST["answer"] ?? [];

    $correctCount = 0;
    $totalQuestions = count($questions);

    /**
     * Проходит по всем вопросам и сравниваем ответы пользователя с правильными.
     */
    if (empty($errors)) {
    foreach ($questions as $index => $q) {
        $correct = $q["correct"];
        $userResponse = $userAnswers[$index] ?? [];

        /**
         * Если вопрос типа checkbox, то ответы пользователя и правильные ответы сортируются
         * для точного сравнения.
         */
        if ($q["type"] === "checkbox") {
            sort($userResponse);
            sort($correct);
            if ($userResponse === $correct) {
                $correctCount++;
            }
        } else {
            if ($correct[0] == $userResponse) {
                $correctCount++;
            }
        }
    }

    /**
     * Вычисляет процент правильных ответов.
     * 
     * Процент правильных ответов рассчитывается как отношение количества правильных ответов
     * к общему числу вопросов, умноженное на 100. Результат округляется до двух знаков после запятой.
     */
    $score = round(($correctCount / $totalQuestions) * 100, 2);

    /**
     * Добавляет результаты теста в массив данных.
     * 
     * Результаты включают имя пользователя, количество правильных ответов и процент правильных ответов.
     * Эти данные добавляются в массив `results`, который хранит все результаты тестов.
     */
    $data["results"][] = [
        "username" => $username,
        "correct" => $correctCount,
        "score" => $score
    ];

    /**
     * Записывает обновленные данные в файл.
     * 
     * Массив данных, включая результаты теста, преобразуется в формат JSON с отступами для улучшенной читаемости.
     * Полученная строка записывается в файл `testData.json`, перезаписывая его содержимое.
     */
    file_put_contents($dataFile, json_encode($data, JSON_PRETTY_PRINT));

    /**
     * Перенаправляет пользователя на страницу с результатами теста.
     * 
     * После завершения обработки теста, скрипт перенаправляет пользователя на страницу `result.php`,
     * передавая количество правильных ответов и процент правильных ответов в URL-параметрах.
     * После этого выполнение скрипта прекращается.
     */
    header("Location: result.php?correct=$correctCount&score=$score");
    exit;
}
}
